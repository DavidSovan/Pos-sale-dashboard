<Window 
    x:Class="PosSale.Views.SaleView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:PosSale.ViewModels"
    xmlns:conv="using:PosSale.Converters"
    xmlns:models="using:PosSale.Models"
    x:DataType="vm:SaleViewModel"
    
    mc:Ignorable="d"
    Width="800"
    Height="600"
    WindowStartupLocation="CenterScreen"
    Title="POS System - Sale">
    <!-- View-specific styles -->
    <Window.Styles>
        <!-- Primary button styling -->
        <Style Selector="Button">
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        <Style Selector="Button:pointerover">
            <Setter Property="Background" Value="{DynamicResource PrimaryHoverBrush}"/>
        </Style>
        <Style Selector="Button:pressed">
            <Setter Property="Background" Value="{DynamicResource PrimaryHoverBrush}"/>
        </Style>

        <!-- Input styling -->
        <Style Selector="TextBox, ComboBox">
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>
        
        <!-- Card styling -->
        <Style Selector="Border[BorderThickness=1]">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="BoxShadow" Value="0 6 20 #1A000000, 0 2 8 #14000000"/>
            <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
        </Style>
    </Window.Styles>
    
    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="2*" />
        </Grid.ColumnDefinitions>
        
        <!-- Left Panel: Products -->
        <Border Grid.Column="0" BorderBrush="{DynamicResource TextMutedBrush}" BorderThickness="0,0,1,0">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- Search and Filter -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                    <TextBox 
                        Text="{Binding SearchText}" 
                        Watermark="Search products..."
                        Width="200"
                        KeyDown="OnSearchKeyDown"/>
                    
                    <ComboBox 
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory}"
                        Width="150">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="models:Category">
                                <TextBlock Text="{Binding Name}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    
                    <Button Content="Search" Command="{Binding SearchCommand}" />
                </StackPanel>
                
                <!-- Error Message -->
                <TextBlock Grid.Row="1" 
                           Text="{Binding ErrorMessage}"
                           Foreground="{DynamicResource ErrorBrush}"
                           TextWrapping="Wrap"
                           IsVisible="{Binding ErrorMessage, Converter={x:Static conv:StringConverters.IsNotNullOrEmpty}}"
                           Margin="0,0,0,10"/>
                
                <!-- Debug Info -->
                <TextBlock Grid.Row="2" 
                           Text="{Binding Products.Count, StringFormat='Products loaded: {0}'}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           Margin="0,0,0,10"/>
                
                <!-- Products List -->
                <ListBox Grid.Row="3" 
                         ItemsSource="{Binding Products}"
                         SelectionMode="Single"
                         Background="{DynamicResource SurfaceBrush}">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="models:Product">
                            <Border BorderThickness="1" BorderBrush="{DynamicResource TextMutedBrush}" Margin="4" Padding="8" CornerRadius="10" BoxShadow="0 6 20 #1A000000, 0 2 8 #14000000" Background="{DynamicResource CardBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Column="0" Text="{Binding Name}" FontWeight="Bold" Foreground="{DynamicResource TextBrush}" />
                                    <TextBlock Grid.Column="1" Text="{Binding Price, StringFormat='${0:F2}'}" Foreground="{DynamicResource TextBrush}" />
                                    <TextBlock Grid.Column="2" Text="{Binding Stock}" Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <TextBlock Grid.Column="3" Text="{Binding Category.Name}" Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <Button Grid.Column="4" Content="Add" 
                                            Command="{Binding $parent[Window].DataContext.AddProductCommand}"
                                            CommandParameter="{Binding}"
                                            Margin="5,0,0,0" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Pagination -->
                <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                    <Button Content="Previous" 
                            Command="{Binding PreviousPageCommand}" />
                    
                    <TextBlock Text="{Binding CurrentPage, StringFormat='Page {0} of {1}'}" 
                               Margin="10,0"
                               VerticalAlignment="Center" />
                    
                    <Button Content="Next" 
                            Command="{Binding NextPageCommand}" />
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Right Panel: Cart -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            
            <TextBlock Text="Cart" 
                       FontSize="18"
                       FontWeight="Bold"
                       Margin="10"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource TextBrush}" />
            <!-- Debug: show cart items count -->
            <TextBlock Grid.Row="0"
                       HorizontalAlignment="Right"
                       Margin="0,10,10,0"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       Text="{Binding CartItems.Count, StringFormat='Cart items: {0}'}"/>
            
            <!-- Cart Items -->
            <ListBox Grid.Row="1"
                     ItemsSource="{Binding CartItems}"
                     Margin="10"
                     Background="{DynamicResource SurfaceBrush}"
                     Foreground="{DynamicResource TextBrush}">
                <ListBox.ItemTemplate>
                    <DataTemplate x:DataType="models:SaleItem">
                        <Border BorderThickness="1" Margin="4" Padding="8" CornerRadius="10" BoxShadow="0 6 20 #1A000000, 0 2 8 #14000000" Background="{DynamicResource CardBrush}">
                            <Grid ColumnDefinitions="2*,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8" VerticalAlignment="Center">
                                <TextBlock Grid.Column="0" Text="{Binding Product.Name}" />
                                <TextBlock Grid.Column="1" Text="Qty:" VerticalAlignment="Center" />
                                <TextBox Grid.Column="2" Width="60" Text="{Binding Quantity}" />
                                <TextBlock Grid.Column="3" Text="{Binding Price, StringFormat='${0:F2}'}" />
                                <TextBlock Grid.Column="4" Text="{Binding Subtotal, StringFormat='${0:F2}'}" FontWeight="Bold" />
                                <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4">
                                    <Button Content="Update"
                                            Command="{Binding $parent[Window].((vm:SaleViewModel)DataContext).UpdateItemCommand}"
                                            CommandParameter="{Binding}" />
                                    <Button Content="Remove" 
                                            Command="{Binding $parent[Window].((vm:SaleViewModel)DataContext).RemoveItemCommand}"
                                            CommandParameter="{Binding}"
                                            Background="{DynamicResource ErrorBrush}"
                                            Foreground="White" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            
            <!-- Summary -->
            <Border Grid.Row="2" BorderThickness="1" Margin="10" Padding="12" CornerRadius="10" BoxShadow="0 6 20 #1A000000, 0 2 8 #14000000" Background="{DynamicResource CardBrush}">
                <StackPanel>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Text="Subtotal:" Grid.Row="0" Grid.Column="0" Margin="0,0,10,5" Foreground="{DynamicResource TextBrush}" />
                        <TextBlock Text="{Binding Subtotal, StringFormat='${0:F2}'}" Grid.Row="0" Grid.Column="1" HorizontalAlignment="Right" Margin="0,0,0,5" Foreground="{DynamicResource TextBrush}" />
                        
                        <TextBlock Text="Discount:" Grid.Row="1" Grid.Column="0" Margin="0,0,10,5" Foreground="{DynamicResource TextBrush}"/>
                        <TextBox Text="{Binding Discount, StringFormat='{}{0:F2}'}" Grid.Row="1" Grid.Column="1" HorizontalAlignment="Right" Margin="0,0,0,5" Width="80" />
                        
                        <TextBlock Text="Total:" Grid.Row="2" Grid.Column="0" Margin="0,0,10,0" FontWeight="Bold" Foreground="{DynamicResource TextBrush}" />
                        <TextBlock Text="{Binding Total, StringFormat='${0:F2}'}" Grid.Row="2" Grid.Column="1" HorizontalAlignment="Right" FontWeight="Bold" Foreground="{DynamicResource TextBrush}" />
                    </Grid>
                </StackPanel>
            </Border>
            
            <!-- Payment and Checkout -->
            <Border Grid.Row="3" BorderThickness="1" Margin="10" Padding="12" CornerRadius="10" BoxShadow="0 6 20 #1A000000, 0 2 8 #14000000" Background="{DynamicResource CardBrush}">
                <StackPanel>
                    <Grid Margin="0,0,0,10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Text="Payment Method:" Grid.Row="0" Grid.Column="0" Margin="0,0,10,5" Foreground="{DynamicResource TextBrush}"/>
                        <ComboBox Grid.Row="0" Grid.Column="1"
                                  ItemsSource="{Binding PaymentMethods}"
                                  SelectedItem="{Binding PaymentMethod}"
                                  Width="120" Margin="0,0,0,5"/>
                        
                        <TextBlock Text="Amount:" Grid.Row="1" Grid.Column="0" Margin="0,0,10,0" Foreground="{DynamicResource TextBrush}"/>
                        <TextBox Text="{Binding PaymentAmount, StringFormat='{}{0:F2}'}" Grid.Row="1" Grid.Column="1" Width="80" HorizontalAlignment="Left" />
                    </Grid>
                    
                    <Button Content="Checkout" 
                            Command="{Binding CheckoutCommand}"
                            HorizontalAlignment="Stretch"
                            Height="40"
                            FontSize="16"
                            FontWeight="Bold"
                            Background="{DynamicResource SuccessBrush}"
                            Foreground="White" />
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- Loading Overlay -->
        <Border Background="#80000000"
                IsVisible="{Binding IsLoading}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid>
                <ProgressBar IsIndeterminate="True" Width="150" Height="8" HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</Window>